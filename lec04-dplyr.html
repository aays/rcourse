<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Joel Östblom" />


<title>Data wrangling and visualization in the tidyverse</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="image/favicon.png">
<style type="text/css">

table {
    border-collapse: collapse;
}

thead {
    border-top: solid #DCDCDC;
    border-bottom: solid #DCDCDC;
}

tr.odd {
    background-color: #F8F8F8;
}

tr:last-child {
    border-bottom: solid #DCDCDC;
}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EEB430H1</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-map-o"></span>
     
    Syllabus
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lec01-introduction.html">Sept. 7: Intro to course, programming, RStudio, and R Markdown</a>
    </li>
    <li>
      <a href="lec02-basic-r.html">Sept. 12: Variable assignment, vectors, functions</a>
    </li>
    <li>
      <a href="lec03-basic-r.html">Sept. 14: Data frames, intro to dplyr</a>
    </li>
    <li>
      <a href="lec04-dplyr.html">Sept. 19: Data wrangling in dplyr, tidy data</a>
    </li>
    <li>
      <a href="lec05-dplyr.html">Sept. 21: More dplyr and tidy data, ggplot intro</a>
    </li>
    <li>
      <a href="lec06-pop-models.html">Sept. 26: Qualitative review of population models</a>
    </li>
    <li>
      <a href="lec07-pop-models.html">Sept. 28: Modelling in R</a>
    </li>
    <li>
      <a href="lec08-stability.html">Oct. 03: Population models in two dimensions</a>
    </li>
    <li>
      <a href="lec09-modeling-r.html">Oct. 05: Fixed points, null clines, and stability</a>
    </li>
    <li>
      <a href="lec10-modelling.html">Oct. 10: Fitting models to data</a>
    </li>
    <li>
      <a href="lec11-modelling.html">Oct. 12: Statistical and probabilistic modelling in R</a>
    </li>
    <li>
      <a href="lec12-datasets.html">Oct. 17: Scientific method, team dynamics, and project datasets</a>
    </li>
    <li>
      <a href="lec13-projects-r.html">Oct. 19: Project and Git in RStudio, and project work</a>
    </li>
    <li>
      <a href="lec14-git.html">Oct. 24: Scientific collaboration, Git and GitHub</a>
    </li>
    <li>
      <a href="lec15-data-viz.html">Oct. 26: Data visualization and project work</a>
    </li>
    <li>
      <a href="lec16-data-viz.html">Oct. 31: Project work, data visualizations</a>
    </li>
    <li>
      <a href="lec17-rmarkdown.html">Nov. 02: Reproducible workflow, Metadata, and R Markdown</a>
    </li>
    <li class="dropdown-header">Nov. 14: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 16: Project work (no lesson)</li>
    <li>
      <a href="lec20-publishing.html">Nov. 21: Preparing a scientific item for academic publishing</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="assignment-01.html">Assignment 1</a>
    </li>
    <li>
      <a href="assignment-02.html">Assignment 2</a>
    </li>
    <li>
      <a href="assignment-03.html">Assignment 3</a>
    </li>
    <li>
      <a href="assignment-04.html">Assignment 4</a>
    </li>
    <li>
      <a href="assignment-05.html">Assignment 5</a>
    </li>
    <li>
      <a href="assignment-06.html">Assignment 6</a>
    </li>
    <li>
      <a href="assignment-07.html">Assignment 7</a>
    </li>
    <li>
      <a href="assignment-08.html">Assignment 8</a>
    </li>
    <li>
      <a href="assignment-final.html">Final assignment</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-caret-square-o-right"></span>
     
    Slides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="slides/lec12-datasets.html">Oct. 17: Scientific method, team dynamics, and project datasets</a>
    </li>
  </ul>
</li>
<li>
  <a href="resources.html">
    <span class="fa fa-question"></span>
     
    Resources and FAQ
  </a>
</li>
<li>
  <a href="about.html">
    <span class="fa fa-info"></span>
     
    About
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bars"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="mailto:joel.ostblom@mail.utoronto.ca">
        <span class="fa fa-envelope"></span>
         
        Contact
      </a>
    </li>
    <li>
      <a href="https://github.com/uoftcoders/rcourse">
        <span class="fa fa-github"></span>
         
        GitHub
      </a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Data wrangling and visualization in the tidyverse</h1>
<h4 class="author"><em>Joel Östblom</em></h4>

</div>


<div id="lesson-preamble" class="section level2">
<h2>Lesson preamble</h2>
<blockquote>
<h3 id="learning-objectives">Learning Objectives</h3>
<ul>
<li>Understand the split-apply-combine concept for data analysis.</li>
<li>Use <code>summarize</code>, <code>group_by</code>, and <code>tally</code> to split a data frame into groups of observations, apply a summary statistics for each group, and then combine the results.</li>
<li>Produce scatter plots, line plots, and histograms using ggplot.</li>
<li>Set universal plot settings.</li>
<li>Understand and apply faceting in ggplot.</li>
</ul>
<h3 id="lesson-outline">Lesson outline</h3>
<ul>
<li>Split-apply-combine techniques in <strong><code>dplyr</code></strong> (20 min)</li>
<li>Using <code>tally</code> to summarize categorical data (10 min)</li>
<li>Plotting with <strong><code>ggplot2</code></strong> (15 min)</li>
<li>Building plots iteratively (15 min)</li>
<li>Split-apply-combine… plot! (20 min)</li>
<li>Faceting (10 min)</li>
</ul>
</blockquote>
<hr />
</div>
<div id="setting-up" class="section level2">
<h2>Setting up</h2>
<p>Start by loading the required packages. Both <strong><code>ggplot2</code></strong> and <strong><code>dplyr</code></strong> are included in the <strong><code>tidyverse</code></strong> package collection.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Install if needed</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># install.packages(&#39;tidyverse&#39;)</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<p>Load the data we saved in the previous lesson.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Download if needed</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># download.file(&quot;https://ndownloader.figshare.com/files/2292169&quot;, &quot;data/portal_data.csv&quot;)</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">surveys &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&#39;portal_data.csv&#39;</span>)</a></code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   record_id = col_integer(),
##   month = col_integer(),
##   day = col_integer(),
##   year = col_integer(),
##   plot_id = col_integer(),
##   species_id = col_character(),
##   sex = col_character(),
##   hindfoot_length = col_integer(),
##   weight = col_integer(),
##   genus = col_character(),
##   species = col_character(),
##   taxa = col_character(),
##   plot_type = col_character()
## )</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">surveys</a></code></pre></div>
<pre><code>## # A tibble: 34,786 x 13
##    record_id month   day  year plot_id species_id sex   hindfoot_length
##        &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;           &lt;int&gt;
##  1         1     7    16  1977       2 NL         M                  32
##  2        72     8    19  1977       2 NL         M                  31
##  3       224     9    13  1977       2 NL         &lt;NA&gt;               NA
##  4       266    10    16  1977       2 NL         &lt;NA&gt;               NA
##  5       349    11    12  1977       2 NL         &lt;NA&gt;               NA
##  6       363    11    12  1977       2 NL         &lt;NA&gt;               NA
##  7       435    12    10  1977       2 NL         &lt;NA&gt;               NA
##  8       506     1     8  1978       2 NL         &lt;NA&gt;               NA
##  9       588     2    18  1978       2 NL         M                  NA
## 10       661     3    11  1978       2 NL         &lt;NA&gt;               NA
## # ... with 34,776 more rows, and 5 more variables: weight &lt;int&gt;,
## #   genus &lt;chr&gt;, species &lt;chr&gt;, taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
</div>
<div id="split-apply-combine-technique-in-dplyr" class="section level2">
<h2>Split-apply-combine technique in dplyr</h2>
<p>Many data analysis tasks can be approached using the <em>split-apply-combine</em> paradigm: split the data into groups, apply some analysis to each group, and then combine the results.</p>
<p><strong><code>dplyr</code></strong> facilitates this workflow through the use of <code>group_by()</code> to split data and <code>summarize()</code>, which collapses each group into a single-row summary of that group. The arguments to <code>group_by()</code> are the column names that contain the <strong>categorical</strong> variables for which you want to calculate the summary statistics. Let’s view the mean <code>weight</code> by sex.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   sex   mean_weight
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 F              NA
## 2 M              NA
## 3 &lt;NA&gt;           NA</code></pre>
<p>The mean weights become <code>NA</code> since there are individual observations that are <code>NA</code>. Let’s remove those observations.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   sex   mean_weight
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 F            42.2
## 2 M            43.0
## 3 &lt;NA&gt;         64.7</code></pre>
<p>There is one row here that is neither male nor female, these are observations where the animal escaped before the sex could not be determined. Let’s remove those as well.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(sex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight))</a></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   sex   mean_weight
##   &lt;chr&gt;       &lt;dbl&gt;
## 1 F            42.2
## 2 M            43.0</code></pre>
<p>You can also group by multiple columns:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(sex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(genus, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight))</a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
## # Groups:   genus [?]
##    genus           sex   mean_weight
##    &lt;chr&gt;           &lt;chr&gt;       &lt;dbl&gt;
##  1 Baiomys         F            9.16
##  2 Baiomys         M            7.36
##  3 Chaetodipus     F           23.8 
##  4 Chaetodipus     M           24.7 
##  5 Dipodomys       F           55.2 
##  6 Dipodomys       M           56.2 
##  7 Neotoma         F          154.  
##  8 Neotoma         M          166.  
##  9 Onychomys       F           26.8 
## 10 Onychomys       M           26.2 
## 11 Perognathus     F            8.57
## 12 Perognathus     M            8.20
## 13 Peromyscus      F           22.5 
## 14 Peromyscus      M           20.6 
## 15 Reithrodontomys F           11.2 
## 16 Reithrodontomys M           10.2 
## 17 Sigmodon        F           71.7 
## 18 Sigmodon        M           61.3 
## 19 Spermophilus    F           57   
## 20 Spermophilus    M          130</code></pre>
<p>Since we will use the same filtered and grouped data frame in multiple code chunks below, we could assign this subset of the data to a new variable and use this variable in the subsequent code chunks instead of typing out the functions each time.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">filtered_surveys &lt;-<span class="st"> </span>surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(sex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(genus, sex)</a></code></pre></div>
<p>If you want to display more data, you can use the <code>print()</code> function at the end of your chain with the argument <code>n</code> specifying the number of rows to display.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">filtered_surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">    </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="dv">15</span>) <span class="co"># Will change the knitted output, not the notebook</span></a></code></pre></div>
<pre><code>## # A tibble: 20 x 3
## # Groups:   genus [?]
##    genus           sex   mean_weight
##    &lt;chr&gt;           &lt;chr&gt;       &lt;dbl&gt;
##  1 Baiomys         F            9.16
##  2 Baiomys         M            7.36
##  3 Chaetodipus     F           23.8 
##  4 Chaetodipus     M           24.7 
##  5 Dipodomys       F           55.2 
##  6 Dipodomys       M           56.2 
##  7 Neotoma         F          154.  
##  8 Neotoma         M          166.  
##  9 Onychomys       F           26.8 
## 10 Onychomys       M           26.2 
## 11 Perognathus     F            8.57
## 12 Perognathus     M            8.20
## 13 Peromyscus      F           22.5 
## 14 Peromyscus      M           20.6 
## 15 Reithrodontomys F           11.2 
## # ... with 5 more rows</code></pre>
<p>Once the data are grouped, you can also summarize multiple variables at the same time. For instance, we could add a column indicating the minimum weight for each species for each sex:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">filtered_surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight),</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">              <span class="dt">min_weight =</span> <span class="kw">min</span>(weight))</a></code></pre></div>
<pre><code>## # A tibble: 20 x 4
## # Groups:   genus [?]
##    genus           sex   mean_weight min_weight
##    &lt;chr&gt;           &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
##  1 Baiomys         F            9.16          6
##  2 Baiomys         M            7.36          6
##  3 Chaetodipus     F           23.8           5
##  4 Chaetodipus     M           24.7           4
##  5 Dipodomys       F           55.2          10
##  6 Dipodomys       M           56.2          12
##  7 Neotoma         F          154.           32
##  8 Neotoma         M          166.           30
##  9 Onychomys       F           26.8           5
## 10 Onychomys       M           26.2           9
## 11 Perognathus     F            8.57          4
## 12 Perognathus     M            8.20          4
## 13 Peromyscus      F           22.5           8
## 14 Peromyscus      M           20.6           7
## 15 Reithrodontomys F           11.2           4
## 16 Reithrodontomys M           10.2           4
## 17 Sigmodon        F           71.7          15
## 18 Sigmodon        M           61.3          16
## 19 Spermophilus    F           57            57
## 20 Spermophilus    M          130           130</code></pre>
<div id="challenge" class="section level4">
<h4>Challenge</h4>
<ol style="list-style-type: decimal">
<li><p>Use <code>group_by()</code> and <code>summarize()</code> to find the mean, min, and max hindfoot length for each species.</p></li>
<li><p>What was the heaviest animal measured in each year? Return the columns <code>year</code>, <code>genus</code>, <code>species</code>, and <code>weight</code>.</p></li>
</ol>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">## Answer 1</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="st">    </span><span class="kw">summarize</span>(</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">        <span class="dt">mean_hindfoot_length =</span> <span class="kw">mean</span>(hindfoot_length),</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">        <span class="dt">min_hindfoot_length =</span> <span class="kw">min</span>(hindfoot_length),</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">        <span class="dt">max_hindfoot_length =</span> <span class="kw">max</span>(hindfoot_length)</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">    )</a></code></pre></div>
<pre><code>## # A tibble: 22 x 4
##    species     mean_hindfoot_length min_hindfoot_length max_hindfoot_leng…
##    &lt;chr&gt;                      &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;
##  1 albigula                    32.3                  21                 70
##  2 baileyi                     26.1                   2                 47
##  3 eremicus                    20.2                  11                 30
##  4 flavus                      15.6                   7                 38
##  5 fulvescens                  17.5                  15                 20
##  6 fulviventer                 26.7                  21                 38
##  7 harrisi                     33                    31                 35
##  8 hispidus                    28.0                  20                 39
##  9 intermedius                 22.2                  20                 23
## 10 leucogaster                 20.5                  12                 39
## # ... with 12 more rows</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">## Answer 2</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="st">    </span><span class="kw">filter</span>(weight <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(weight)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># This is going to compare to the max weight within each group</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="st">    </span><span class="kw">select</span>(year, genus, species, weight) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="st">    </span><span class="kw">arrange</span>(year)</a></code></pre></div>
<pre><code>## # A tibble: 27 x 4
## # Groups:   year [26]
##     year genus     species     weight
##    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;int&gt;
##  1  1977 Dipodomys spectabilis    149
##  2  1978 Neotoma   albigula       232
##  3  1978 Neotoma   albigula       232
##  4  1979 Neotoma   albigula       274
##  5  1980 Neotoma   albigula       243
##  6  1981 Neotoma   albigula       264
##  7  1982 Neotoma   albigula       252
##  8  1983 Neotoma   albigula       256
##  9  1984 Neotoma   albigula       259
## 10  1985 Neotoma   albigula       225
## # ... with 17 more rows</code></pre>
</div>
<div id="using-tally-to-summarize-categorical-data" class="section level3">
<h3>Using tally to summarize categorical data</h3>
<p>When working with data, it is also common to want to know the number of observations found for each factor or combination of factors. For this, <strong><code>dplyr</code></strong> provides <code>tally()</code>. For example, if we want to group by taxa and find the number of observations for each taxa, we would do:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(taxa) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   taxa        n
##   &lt;chr&gt;   &lt;int&gt;
## 1 Bird      450
## 2 Rabbit     75
## 3 Reptile    14
## 4 Rodent  34247</code></pre>
<p>We can also use <code>tally()</code> when grouping on multiple variables:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(taxa, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
## # Groups:   taxa [?]
##   taxa    sex       n
##   &lt;chr&gt;   &lt;chr&gt; &lt;int&gt;
## 1 Bird    &lt;NA&gt;    450
## 2 Rabbit  &lt;NA&gt;     75
## 3 Reptile &lt;NA&gt;     14
## 4 Rodent  F     15690
## 5 Rodent  M     17348
## 6 Rodent  &lt;NA&gt;   1209</code></pre>
<p>Here, <code>tally()</code> is the action applied to the groups created by <code>group_by()</code> and counts the total number of records for each category.</p>
<p>If there are many groups, <code>tally()</code> is not that useful on its own. For example, when we want to view the five most abundant species among the observations:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 40 x 2
##    species             n
##    &lt;chr&gt;           &lt;int&gt;
##  1 albigula         1252
##  2 audubonii          75
##  3 baileyi          2891
##  4 bilineata         303
##  5 brunneicapillus    50
##  6 chlorurus          39
##  7 clarki              1
##  8 eremicus         1299
##  9 flavus           1597
## 10 fulvescens         75
## # ... with 30 more rows</code></pre>
<p>Since there are 40 rows in this output, we would like to order the table to display the most abundant species first. In <code>dplyr</code>, we say that we want to <code>arrange()</code> the data.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="st">    </span><span class="kw">arrange</span>(n)</a></code></pre></div>
<pre><code>## # A tibble: 40 x 2
##    species          n
##    &lt;chr&gt;        &lt;int&gt;
##  1 clarki           1
##  2 scutalatus       1
##  3 tereticaudus     1
##  4 tigris           1
##  5 uniparens        1
##  6 viridis          1
##  7 leucophrys       2
##  8 savannarum       2
##  9 fuscus           5
## 10 undulatus        5
## # ... with 30 more rows</code></pre>
<p>Still not that useful. Since we are interested in the most abundant species, we want to display those with the highest count first, in other words, we want to arrange the column <code>n</code> in descending order:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="st">    </span><span class="kw">head</span>(<span class="dv">5</span>)</a></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   species          n
##   &lt;chr&gt;        &lt;int&gt;
## 1 merriami     10596
## 2 penicillatus  3123
## 3 ordii         3027
## 4 baileyi       2891
## 5 megalotis     2609</code></pre>
<p>If we want to include more attributes about these species, we can include these in the call to <code>group_by()</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(species, taxa, genus) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5"><span class="st">    </span><span class="kw">head</span>(<span class="dv">5</span>)</a></code></pre></div>
<pre><code>## # A tibble: 5 x 4
## # Groups:   species, taxa [5]
##   species      taxa   genus               n
##   &lt;chr&gt;        &lt;chr&gt;  &lt;chr&gt;           &lt;int&gt;
## 1 merriami     Rodent Dipodomys       10596
## 2 penicillatus Rodent Chaetodipus      3123
## 3 ordii        Rodent Dipodomys        3027
## 4 baileyi      Rodent Chaetodipus      2891
## 5 megalotis    Rodent Reithrodontomys  2609</code></pre>
<p>Be careful not to include anything that would split the group into subgroups, such as <code>sex</code>, <code>year</code> etc.</p>
<div id="challenge-1" class="section level4">
<h4>Challenge</h4>
<ol style="list-style-type: decimal">
<li><p>How many individuals were caught in each <code>plot_type</code> surveyed?</p></li>
<li><p>You saw above how to count the number of individuals of each <code>sex</code> using a combination of <code>group_by()</code> and <code>tally()</code>. How could you get the same result using <code>group_by()</code> and <code>summarize()</code>? Hint: see <code>?n</code>.</p></li>
</ol>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">## Answer 1</a>
<a class="sourceLine" id="cb35-2" data-line-number="2">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(plot_type) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="st">    </span>tally</a></code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   plot_type                     n
##   &lt;chr&gt;                     &lt;int&gt;
## 1 Control                   15611
## 2 Long-term Krat Exclosure   5118
## 3 Rodent Exclosure           4233
## 4 Short-term Krat Exclosure  5906
## 5 Spectab exclosure          3918</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">## Answer 2</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>())</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   sex       n
##   &lt;chr&gt; &lt;int&gt;
## 1 F     15690
## 2 M     17348
## 3 &lt;NA&gt;   1748</code></pre>
</div>
</div>
</div>
<div id="plotting-with-ggplot2" class="section level2">
<h2>Plotting with ggplot2</h2>
<p><strong><code>ggplot2</code></strong> is a plotting package that makes it simple to create complex plots from data frames. The name <strong><code>ggplot2</code></strong> comes from its inspiration, the book “A grammar of graphics”, and the main goal is to allow coders to express their desired outcome on a high level instead of telling the computer every detail about what will happen. For example, you would say “color my data by species” instead of “go through this data frame and plot any observations of species1 in blue, any observations of species2 in red, etc”. Thanks to this functional way of interfaces with data, only minimal changes are required if the underlying data change or to change the type of plot. This helps in thinking about the data and creating publication quality plots with minimal amounts of adjustments and tweaking.</p>
<p>ggplot graphics are built step by step by adding new elements, or layers. Adding layers in this fashion allows for extensive flexibility and customization of plots. To build a ggplot, we need to:</p>
<ol style="list-style-type: decimal">
<li>Use the <code>ggplot()</code> function and bind the plot to a specific data frame using the <code>data</code> argument</li>
</ol>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Remember, if the arguments are provided in the right order then the names of the arguments can be omitted.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="kw">ggplot</span>(surveys)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Define aesthetics (<code>aes</code>), by selecting the variables to be plotted and the variables to define the presentation such as plotting size, shape color, etc.</li>
</ol>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length))</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Add <code>geoms</code> – geometrical objects as a graphical representation of the data in the plot (points, lines, bars). <strong><code>ggplot2</code></strong> offers many different geoms; we will use a few common ones today, including:
<ul>
<li><code>geom_point()</code> for scatter plots, dot plots, etc.</li>
<li><code>geom_line()</code> for trend lines, time-series, etc.</li>
<li><code>geom_histogram()</code> for histograms</li>
</ul></li>
</ol>
<p>To add a geom to the plot use <code>+</code> operator. Because we have two continuous variables, let’s use <code>geom_point()</code> first:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="co"># If this takes way too long on your machine, create a subset from a random</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="co"># sample of a suitable size and continue working with this instead of `survey`.</span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="co">#survey_subset &lt;- sample_n(surveys, size = 5000)</span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4"></a>
<a class="sourceLine" id="cb42-5" data-line-number="5"><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) <span class="op">+</span></a>
<a class="sourceLine" id="cb42-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_point</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>The <code>+</code> in the <strong><code>ggplot2</code></strong> package is particularly useful because it allows you to modify existing <code>ggplot</code> objects. This means you can easily set up plot “templates” and conveniently explore different types of plots, so the above plot can also be generated with code like this:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="co"># Assign plot to a variable</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">surveys_plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length))</a>
<a class="sourceLine" id="cb44-3" data-line-number="3"></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="co"># Draw the plot</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">surveys_plot <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/first-ggplot-with-plus-1.png" width="672" /></p>
<p>Notes:</p>
<ul>
<li>Anything you put in the <code>ggplot()</code> function can be seen by any geom layers that you add (i.e., these are universal plot settings). This includes the x and y axis you set up in <code>aes()</code>.</li>
<li>You can also specify aesthetics for a given geom independently of the aesthetics defined globally in the <code>ggplot()</code> function.</li>
<li>The <code>+</code> sign used to add layers must be placed at the end of each line containing a layer. If, instead, the <code>+</code> sign is added in the line before the other layer, <strong><code>ggplot2</code></strong> will not add the new layer and R will return an error message.</li>
</ul>
<div id="building-plots-iteratively" class="section level3">
<h3>Building plots iteratively</h3>
<p>Building plots with ggplot is typically an iterative process. We start by defining the dataset we’ll use, lay the axes, and choose a geom:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>Then, we start modifying this plot to extract more information from it. For instance, we can add transparency (<code>alpha</code>) to reduce overplotting:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) <span class="op">+</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>Based on the hindfoot length and the weights, there appears to be 4-5 clusters in this data. Potentially, one of the categorical variables we have in the data could explain this pattern. Coloring the data points according to a categorical variable is an easy way to find out if there seems to be correlation. Let’s try this with <code>plot_type</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length, <span class="dt">color =</span> plot_type)) <span class="op">+</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>It seems like the type of plot the animal was captured on correlates well with some of these clusters, but there are still many that are quite mixed. Let’s try to do better! This time, the information about the data can provide some clues to which variable to look at. The plot above suggests that there might be 4-5 clusters, so a variable with 4-5 values is a good guess for what could explain the observed pattern in the scatter plot.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="st">    </span><span class="kw">summarize_all</span>(n_distinct)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 13
##   record_id month   day  year plot_id species_id   sex hindfoot_length
##       &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt;           &lt;int&gt;
## 1     34786    12    31    26      24         48     3              57
## # ... with 5 more variables: weight &lt;int&gt;, genus &lt;int&gt;, species &lt;int&gt;,
## #   taxa &lt;int&gt;, plot_type &lt;int&gt;</code></pre>
<p>Remember that there are still <code>NA</code> values here, that’s why there appears to be three sexes although there is only male and female. There are four taxa so that could be a good candidate, let’s see which those are.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-2" data-line-number="2"><span class="st">    </span><span class="kw">distinct</span>(taxa)</a></code></pre></div>
<pre><code>## # A tibble: 4 x 1
##   taxa   
##   &lt;chr&gt;  
## 1 Rodent 
## 2 Rabbit 
## 3 Bird   
## 4 Reptile</code></pre>
<p>It seems reasonable that these taxa contain animals different enough to have diverse weights and length of their feet. Lets use this categorical variable to color the scatter plot.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="kw">ggplot</span>(surveys, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length, <span class="dt">color =</span> taxa)) <span class="op">+</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 4048 rows containing missing values (geom_point).</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>Only rodents? That was unexpected… Let’s check what’s going on.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(taxa) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb58-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 4 x 2
##   taxa        n
##   &lt;chr&gt;   &lt;int&gt;
## 1 Bird      450
## 2 Rabbit     75
## 3 Reptile    14
## 4 Rodent  34247</code></pre>
<p>There is definitely mostly rodents in our data set…</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># control by removing `!`</span></a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(taxa) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-4" data-line-number="4"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   taxa       n
##   &lt;chr&gt;  &lt;int&gt;
## 1 Rodent 31438</code></pre>
<p>…and it turns out that only rodents, have had their hindfeet measured!</p>
<p>Let’s remove all animals that did not have their hindfeet measured, including those rodents that did not. Animals without their weight measured will also be removed.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" data-line-number="1">surveys_hf_wt &lt;-<span class="st"> </span>surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(weight))</a>
<a class="sourceLine" id="cb62-3" data-line-number="3"></a>
<a class="sourceLine" id="cb62-4" data-line-number="4">surveys_hf_wt <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb62-5" data-line-number="5"><span class="st">    </span><span class="kw">summarize_all</span>(n_distinct)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 13
##   record_id month   day  year plot_id species_id   sex hindfoot_length
##       &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt;           &lt;int&gt;
## 1     30738    12    31    26      24         24     3              55
## # ... with 5 more variables: weight &lt;int&gt;, genus &lt;int&gt;, species &lt;int&gt;,
## #   taxa &lt;int&gt;, plot_type &lt;int&gt;</code></pre>
<p>Maybe the genus can explain what we are seeing.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="kw">ggplot</span>(surveys_hf_wt, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length, <span class="dt">color =</span> genus)) <span class="op">+</span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>Now this looks good! There is a clear separation between different genus, but also significant spread within genus, for example in the weight of the green Neotoma observations. There are also two clearly separate clusters that are both colored in olive green (Dipodomys). Maybe separating the observations into different species would be better?</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1"><span class="kw">ggplot</span>(surveys_hf_wt, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length, <span class="dt">color =</span> species)) <span class="op">+</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>Great! Together with the genus plot, this definitely seem to explain most of the variance we see in the hindfoot length and weight measurements. It is still a bit messy as it appears like we have around 5 clusters, but there are 21 species in the legend.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1">surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-4" data-line-number="4"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-5" data-line-number="5"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 21 x 2
##    species          n
##    &lt;chr&gt;        &lt;int&gt;
##  1 merriami      9739
##  2 penicillatus  2978
##  3 baileyi       2808
##  4 ordii         2793
##  5 megalotis     2429
##  6 torridus      2085
##  7 spectabilis   2026
##  8 flavus        1471
##  9 eremicus      1200
## 10 albigula      1046
## # ... with 11 more rows</code></pre>
<p>There is a big drop from 838 to 159, let’s include only those with more than 800 observations.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1">abundant_species &lt;-<span class="st"> </span>surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb68-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb68-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb68-4" data-line-number="4"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb68-5" data-line-number="5"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb68-6" data-line-number="6"><span class="st">    </span><span class="kw">filter</span>(n <span class="op">&gt;</span><span class="st"> </span><span class="dv">800</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#</span></a>
<a class="sourceLine" id="cb68-7" data-line-number="7"><span class="st">    </span><span class="kw">select</span>(species)</a>
<a class="sourceLine" id="cb68-8" data-line-number="8"></a>
<a class="sourceLine" id="cb68-9" data-line-number="9">abundant_species</a></code></pre></div>
<pre><code>## # A tibble: 12 x 1
##    species     
##    &lt;chr&gt;       
##  1 merriami    
##  2 penicillatus
##  3 baileyi     
##  4 ordii       
##  5 megalotis   
##  6 torridus    
##  7 spectabilis 
##  8 flavus      
##  9 eremicus    
## 10 albigula    
## 11 leucogaster 
## 12 maniculatus</code></pre>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">surveys_abun_species &lt;-<span class="st"> </span>surveys <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(hindfoot_length) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb70-3" data-line-number="3"><span class="st">        </span><span class="op">!</span><span class="kw">is.na</span>(weight) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb70-4" data-line-number="4"><span class="st">        </span>species <span class="op">%in%</span><span class="st"> </span>abundant_species<span class="op">$</span>species)</a>
<a class="sourceLine" id="cb70-5" data-line-number="5"></a>
<a class="sourceLine" id="cb70-6" data-line-number="6">surveys_abun_species</a></code></pre></div>
<pre><code>## # A tibble: 30,320 x 13
##    record_id month   day  year plot_id species_id sex   hindfoot_length
##        &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;           &lt;int&gt;
##  1       845     5     6  1978       2 NL         M                  32
##  2      1164     8     5  1978       2 NL         M                  34
##  3      1261     9     4  1978       2 NL         M                  32
##  4      1756     4    29  1979       2 NL         M                  33
##  5      1818     5    30  1979       2 NL         M                  32
##  6      1882     7     4  1979       2 NL         M                  32
##  7      2133    10    25  1979       2 NL         F                  33
##  8      2184    11    17  1979       2 NL         F                  30
##  9      2406     1    16  1980       2 NL         F                  33
## 10      3000     5    18  1980       2 NL         F                  31
## # ... with 30,310 more rows, and 5 more variables: weight &lt;int&gt;,
## #   genus &lt;chr&gt;, species &lt;chr&gt;, taxa &lt;chr&gt;, plot_type &lt;chr&gt;</code></pre>
<p>Still has almost 25k observations, so only 10k was removed.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="kw">ggplot</span>(surveys_abun_species, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length, <span class="dt">color =</span> species)) <span class="op">+</span></a>
<a class="sourceLine" id="cb72-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<div id="challenge-2" class="section level4">
<h4>Challenge</h4>
<p>Create a scatter plot of <code>hindfoot_length</code> over <code>species</code> with the <code>weight</code> showing in different colors. Is there any problem with this plot? <em>Hint: think about how many observations there are</em></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="kw">ggplot</span>(surveys_abun_species, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> species, <span class="dt">color =</span> hindfoot_length)) <span class="op">+</span></a>
<a class="sourceLine" id="cb73-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="fl">0.1</span>, <span class="dt">position =</span> <span class="st">&#39;jitter&#39;</span>)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
</div>
</div>
<div id="split-apply-combine-plot" class="section level3">
<h3>Split-apply-combine… plot!</h3>
<p>In this section, we will learn how to work with <code>**dplyr**</code> and <code>**ggplot**</code> together. Aided by the pipes (<code>%&gt;%</code>), we can create a powerful data exploration workflow using these two packages.</p>
<p>Let’s calculate number of counts per year for each species. First we need to group the data and count records within each group:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, genus) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n)) <span class="co"># Adding arrange just to compare with histogram</span></a></code></pre></div>
<pre><code>## # A tibble: 178 x 3
## # Groups:   year [26]
##     year genus           n
##    &lt;int&gt; &lt;chr&gt;       &lt;int&gt;
##  1  2002 Chaetodipus  1243
##  2  1983 Dipodomys     953
##  3  1985 Dipodomys     951
##  4  2000 Chaetodipus   913
##  5  1982 Dipodomys     896
##  6  1997 Dipodomys     830
##  7  2001 Chaetodipus   781
##  8  1981 Dipodomys     733
##  9  1987 Dipodomys     688
## 10  1980 Dipodomys     667
## # ... with 168 more rows</code></pre>
<p>We could assign this table to a variable, and then pass that variable to <code>ggplot()</code>.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">yearly_counts &lt;-<span class="st"> </span>surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a>
<a class="sourceLine" id="cb76-4" data-line-number="4"></a>
<a class="sourceLine" id="cb76-5" data-line-number="5"><span class="kw">ggplot</span>(yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> n)) <span class="op">+</span></a>
<a class="sourceLine" id="cb76-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_histogram</span>()</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
<p>Creating an intermediate variable would be preferable for time consuming calculations, because you would not want to do that operation every time you change the plot aesthetics.</p>
<p>If it is not a time consuming calculation or you would like the flexibility of changing the data summary and the plotting options in the same code chunk, you can pipe the output of your split-apply-combine operation to the plotting command:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n)) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_histogram</span>()</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>We can perform a quick check that the plot corresponds to the table by coloring the histogram by species:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> n, <span class="dt">fill =</span> species)) <span class="op">+</span><span class="st"> </span><span class="co"># `fill` is specific for histograms</span></a>
<a class="sourceLine" id="cb80-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_histogram</span>()</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
<p>Let’s explore how the number of each genus varies over time. Longitudinal data can be visualized as a line plot with years on the x axis and counts on the y axis:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb82-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb82-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb82-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n)) <span class="op">+</span></a>
<a class="sourceLine" id="cb82-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>Unfortunately, this does not work because we plotted data for all the species together. We need to tell ggplot to draw a line for each species by modifying the aesthetic function to include <code>group = species</code>:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">group =</span> species)) <span class="op">+</span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<p>We will be able to distinguish species in the plot if we add colors (using <code>color</code> also automatically groups the data):</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb84-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> species)) <span class="op">+</span><span class="st"> </span><span class="co"># `color` groups automatically</span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_line</span>() <span class="co"># try adding `size = 2`</span></a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-46-1.png" width="672" /></p>
</div>
<div id="faceting" class="section level3">
<h3>Faceting</h3>
<p>ggplot has a special technique called <em>faceting</em> that allows the user to split one plot into multiple subplots based on a variable included in the dataset. We will use it to make a time series plot for each species:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n)) <span class="op">+</span><span class="st"> </span><span class="co">#</span></a>
<a class="sourceLine" id="cb85-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb85-6" data-line-number="6"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>Now we would like to split the line in each plot by the sex of each individual measured. To do that we need to make counts in the data frame grouped by <code>year</code>, <code>species</code>, and <code>sex</code>:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>()</a></code></pre></div>
<pre><code>## # A tibble: 575 x 4
## # Groups:   year, species [?]
##     year species     sex       n
##    &lt;int&gt; &lt;chr&gt;       &lt;chr&gt; &lt;int&gt;
##  1  1977 eremicus    M         2
##  2  1977 flavus      F        14
##  3  1977 flavus      M         8
##  4  1977 leucogaster F         1
##  5  1977 leucogaster &lt;NA&gt;      1
##  6  1977 megalotis   F         1
##  7  1977 megalotis   M         1
##  8  1977 merriami    F        75
##  9  1977 merriami    M       106
## 10  1977 ordii       F        10
## # ... with 565 more rows</code></pre>
<p>We can make the faceted plot by splitting further by sex using <code>color</code> (within a single plot):</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-2" data-line-number="2"><span class="st">    </span><span class="kw">group_by</span>(year, species, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-3" data-line-number="3"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb88-4" data-line-number="4"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> sex)) <span class="op">+</span></a>
<a class="sourceLine" id="cb88-5" data-line-number="5"><span class="st">        </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb88-6" data-line-number="6"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
<p>There are several observations where no sex was recorded. In this case, we are not really interested in the observations of unknown sex, so we can filter out those values.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-2" data-line-number="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(sex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(year, species, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-4" data-line-number="4"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-5" data-line-number="5"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> sex)) <span class="op">+</span></a>
<a class="sourceLine" id="cb89-6" data-line-number="6"><span class="st">        </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb89-7" data-line-number="7"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<p>It is possible to specify exactly which colors to use, to avoid those that are hard to distinguish. We can also change the thickness of the lines, and adjust the x labels so that they don’t overlap. This will be discussed in detail in the data visualization lecture.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">color_names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;orange&#39;</span>)</a>
<a class="sourceLine" id="cb90-2" data-line-number="2"></a>
<a class="sourceLine" id="cb90-3" data-line-number="3">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(sex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-5" data-line-number="5"><span class="st">    </span><span class="kw">group_by</span>(year, species, sex) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-6" data-line-number="6"><span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-7" data-line-number="7"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> sex)) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-8" data-line-number="8"><span class="st">        </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-9" data-line-number="9"><span class="st">        </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> color_names) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-10" data-line-number="10"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species) <span class="op">+</span></a>
<a class="sourceLine" id="cb90-11" data-line-number="11"><span class="st">        </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb90-12" data-line-number="12"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>),</a>
<a class="sourceLine" id="cb90-13" data-line-number="13">               <span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle=</span><span class="dv">30</span>, <span class="dt">hjust=</span><span class="dv">1</span>))</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<div id="challenge-3" class="section level4">
<h4>Challenge</h4>
<p>Use the filtered data frame for all of these questions.</p>
<ol style="list-style-type: decimal">
<li>Remember the histogram colored according to each species? Starting from that code, how could we separate each species into its own subplot?</li>
<li></li>
</ol>
<ol style="list-style-type: lower-alpha">
<li>Which year was the average weight of the animals the highest?</li>
<li>Is the yearly trend the same for all species?</li>
</ol>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="co"># Answers</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="co"># 1</span></a>
<a class="sourceLine" id="cb91-3" data-line-number="3"><span class="kw">ggplot</span>(yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> n, <span class="dt">fill =</span> species)) <span class="op">+</span></a>
<a class="sourceLine" id="cb91-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_histogram</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb91-5" data-line-number="5"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species)</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-52-1.png" width="672" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="co"># 2.a</span></a>
<a class="sourceLine" id="cb93-2" data-line-number="2">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-6" data-line-number="6"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> mean_weight)) <span class="op">+</span></a>
<a class="sourceLine" id="cb93-7" data-line-number="7"><span class="st">        </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-53-1.png" width="672" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="co"># 2.b</span></a>
<a class="sourceLine" id="cb94-2" data-line-number="2">surveys_abun_species <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb94-3" data-line-number="3"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb94-4" data-line-number="4"><span class="st">    </span><span class="kw">group_by</span>(year, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb94-5" data-line-number="5"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(weight)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb94-6" data-line-number="6"><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> mean_weight, <span class="dt">color =</span> species)) <span class="op">+</span></a>
<a class="sourceLine" id="cb94-7" data-line-number="7"><span class="st">        </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb94-8" data-line-number="8"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>species)</a></code></pre></div>
<p><img src="lec04-dplyr_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<p><em>Parts of this lesson material were taken and modified from <a href="http://datacarpentry.org">Data Carpentry</a> under their CC-BY copyright license. See their <a href="http://www.datacarpentry.org/R-ecology-lesson/03-dplyr.html">lesson page</a> for the original source.</em></p>
</div>
</div>
</div>


<hr>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. See the <a href="LICENSE.html">licensing</a> page for more details about copyright information.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
